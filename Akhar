#!/usr/bin/env bash
set -Eeuo pipefail

# If piped, read from real TTY
if [[ ! -t 0 && -r /dev/tty ]]; then
  exec </dev/tty
fi

AKHAR_DIR="/etc/akhar"
FWD_DIR="$AKHAR_DIR/forwards.d"
NGX_DIR="$AKHAR_DIR/nginx.d"
NFT_FILE="$AKHAR_DIR/akhar.nft"
STATE_FILE="$AKHAR_DIR/state.env"
HEALTH_FILE="$AKHAR_DIR/health.env"
HEALTH_STATE="$AKHAR_DIR/health.state"
LOG_FILE="/var/log/akhar-health.log"

# ---------- UI ----------
print_header() {
  clear
  cat <<'ART'
    ___    _    _               _
   / _ \  | |  | |             | |
  / /_\ \ | | _| |__   __ _ _ __| |
  |  _  | | |/ / '_ \ / _` | '__| |
  | | | | |   <| | | | (_| | |  | |
  \_| |_/ |_|\_\_| |_|\__,_|_|  |_|

              Akhar
ART
  echo
  echo "Akhar - Port Forward (TCP) + Reverse Proxy (HTTP) روی لینک SoftEther"
  echo "===================================================================="
  echo
}

pause() { echo; read -rp "برای ادامه Enter بزنید..."; }

die() { echo "❌ $*"; exit 1; }

need_root() {
  [[ "${EUID:-$(id -u)}" -eq 0 ]] || die "این برنامه باید با root اجرا شود. مثال: sudo Akhar"
}

have() { command -v "$1" >/dev/null 2>&1; }

ensure_dirs() {
  mkdir -p "$FWD_DIR" "$NGX_DIR"
  chmod 700 "$AKHAR_DIR" "$FWD_DIR" "$NGX_DIR" || true
  touch "$LOG_FILE" >/dev/null 2>&1 || true
}

require_nft() { have nft || die "nft نصب نیست. (Debian/Ubuntu: apt install nftables -y)"; }
require_nginx() { have nginx || die "nginx نصب نیست. (Debian/Ubuntu: apt install nginx -y)"; }

sanitize_name() {
  local n="$1"
  n="${n// /_}"
  n="$(echo "$n" | tr -c 'a-zA-Z0-9._-' '_' )"
  echo "$n"
}

# ---------- State ----------
default_state() {
  cat >"$STATE_FILE" <<'EOF'
# Akhar state
# VPN_IF: نام اینترفیس سمت همین سرور که ترافیک به سمت طرف مقابل از آن عبور می‌کند (اینترفیس SoftEther/TAP)
VPN_IF=
EOF
  chmod 600 "$STATE_FILE"
}

default_health() {
  cat >"$HEALTH_FILE" <<'EOF'
# Akhar health config
# PEER_IP: IP طرف مقابل داخل VPN برای ping (مثال: 10.10.10.2)
PEER_IP=
# PING_COUNT / PING_TIMEOUT: تنظیمات ping
PING_COUNT=1
PING_TIMEOUT=1
# FAIL_THRESHOLD: بعد از چند شکست پشت سر هم هشدار بده
FAIL_THRESHOLD=3
# CHECK_SERVICES: اگر 1 باشد، وضعیت سرویس‌های vpnserver/vpnclient هم چک می‌شود (اگر وجود داشته باشند)
CHECK_SERVICES=1
# ALERT_CMD: یک فرمان دلخواه برای هشدار (مثال: logger -t akhar "DOWN"; یا curl ...; یا telegram script)
# اگر خالی باشد فقط در لاگ ثبت می‌شود.
ALERT_CMD=
EOF
  chmod 600 "$HEALTH_FILE"
}

load_state() {
  [[ -f "$STATE_FILE" ]] || default_state
  # shellcheck disable=SC1090
  source "$STATE_FILE"
}

load_health() {
  [[ -f "$HEALTH_FILE" ]] || default_health
  # shellcheck disable=SC1090
  source "$HEALTH_FILE"
}

ensure_health_state() {
  if [[ ! -f "$HEALTH_STATE" ]]; then
    echo "FAILS=0" >"$HEALTH_STATE"
    chmod 600 "$HEALTH_STATE"
  fi
  # shellcheck disable=SC1090
  source "$HEALTH_STATE"
  : "${FAILS:=0}"
}

save_health_state() {
  echo "FAILS=${FAILS}" >"$HEALTH_STATE"
  chmod 600 "$HEALTH_STATE"
}

pick_vpn_if() {
  print_header
  echo "انتخاب VPN_IF (اینترفیس عبور ترافیک VPN روی همین سرور)"
  echo "-------------------------------------------------------"
  ip -o link show | awk -F': ' '{print "• " $2}'
  echo "-------------------------------------------------------"
  echo
  read -rp "نام اینترفیس را دقیق وارد کنید (مثال: vpn_qaznic یا tap_soft): " vpnif
  [[ -n "$vpnif" ]] || { echo "❌ خالی است."; pause; return; }
  ip link show "$vpnif" >/dev/null 2>&1 || { echo "❌ اینترفیس پیدا نشد."; pause; return; }

  sed -i "s/^VPN_IF=.*/VPN_IF=${vpnif}/" "$STATE_FILE"
  echo "✅ ثبت شد: VPN_IF=$vpnif"
  pause
}

set_peer_ip() {
  print_header
  load_health
  read -rp "PEER_IP (IP طرف مقابل داخل VPN) را وارد کنید (مثال: 10.10.10.2): " pip
  sed -i "s/^PEER_IP=.*/PEER_IP=${pip}/" "$HEALTH_FILE"
  echo "✅ ثبت شد: PEER_IP=$pip"
  pause
}

# ---------- nft / routing ----------
enable_ip_forward() {
  sysctl -w net.ipv4.ip_forward=1 >/dev/null
  # persist
  if [[ -w /etc/sysctl.conf ]] && ! grep -q '^net.ipv4.ip_forward=1' /etc/sysctl.conf; then
    echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
  fi
}

conf_path_tcp() { echo "$FWD_DIR/$1.tcp"; }
conf_path_http() { echo "$FWD_DIR/$1.http"; }

write_nft() {
  load_state
  [[ -n "${VPN_IF:-}" ]] || die "VPN_IF تنظیم نیست. از منو: تنظیمات -> انتخاب VPN_IF"

  {
    echo "#!/usr/sbin/nft -f"
    echo "# Generated by Akhar"
    echo "flush table inet akhar"
    echo "table inet akhar {"
    echo "  chain prerouting { type nat hook prerouting priority -100; policy accept;"
    if compgen -G "$FWD_DIR/*.tcp" >/dev/null; then
      for f in "$FWD_DIR"/*.tcp; do
        # shellcheck disable=SC1090
        source "$f"
        [[ "${TYPE:-}" == "tcp" ]] || continue
        echo "    tcp dport ${PUB_PORT} dnat to ${DST_IP}:${DST_PORT} comment \"Akhar:${NAME}\""
      done
    fi
    echo "  }"
    echo "  chain postrouting { type nat hook postrouting priority 100; policy accept;"
    echo "    oifname \"${VPN_IF}\" masquerade comment \"Akhar:masq\""
    echo "  }"
    echo "  chain forward { type filter hook forward priority 0; policy drop;"
    echo "    ct state established,related accept"
    if compgen -G "$FWD_DIR/*.tcp" >/dev/null; then
      for f in "$FWD_DIR"/*.tcp; do
        # shellcheck disable=SC1090
        source "$f"
        [[ "${TYPE:-}" == "tcp" ]] || continue
        echo "    ip daddr ${DST_IP} tcp dport ${DST_PORT} accept comment \"Akhar:${NAME}\""
      done
    fi
    echo "  }"
    echo "}"
  } >"$NFT_FILE"

  chmod 600 "$NFT_FILE"
}

ensure_nginx_include() {
  local inc="/etc/nginx/conf.d/akhar.conf"
  if [[ ! -f "$inc" ]]; then
    cat >"$inc" <<EOF
# Managed by Akhar
include $NGX_DIR/*.conf;
EOF
  fi
}

apply_all() {
  require_nft
  ensure_dirs
  enable_ip_forward
  write_nft
  nft -f "$NFT_FILE"
  if have nginx; then
    nginx -t >/dev/null 2>&1 && systemctl reload nginx >/dev/null 2>&1 || true
  fi
  echo "✅ اعمال شد: nft rules + (در صورت وجود) reload nginx"
}

# ---------- TCP forward ----------
tcp_add() {
  print_header
  load_state
  [[ -n "${VPN_IF:-}" ]] || { echo "❌ اول VPN_IF را تنظیم کن."; pause; return; }

  read -rp "نام قانون (مثال: ssh_ir): " name
  name="$(sanitize_name "$name")"
  [[ -n "$name" ]] || { echo "❌ نام خالی است."; pause; return; }
  [[ ! -f "$(conf_path_tcp "$name")" ]] || { echo "❌ این نام از قبل وجود دارد."; pause; return; }

  read -rp "پورت عمومی روی همین سرور (مثال 2222): " pub_port
  [[ "$pub_port" =~ ^[0-9]+$ ]] || { echo "❌ پورت نامعتبر."; pause; return; }

  read -rp "IP مقصد داخل VPN (روی سرور مقابل) (مثال 10.10.10.2): " dst_ip
  [[ -n "$dst_ip" ]] || { echo "❌ IP خالی است."; pause; return; }

  read -rp "پورت مقصد روی سرور مقابل (مثال 22): " dst_port
  [[ "$dst_port" =~ ^[0-9]+$ ]] || { echo "❌ پورت مقصد نامعتبر."; pause; return; }

  cat >"$(conf_path_tcp "$name")" <<EOF
TYPE=tcp
NAME=$name
PUB_PORT=$pub_port
DST_IP=$dst_ip
DST_PORT=$dst_port
EOF
  chmod 600 "$(conf_path_tcp "$name")"

  apply_all
  echo
  echo "✅ TCP Forward اضافه شد: 0.0.0.0:${pub_port} → ${dst_ip}:${dst_port}"
  echo "یادآوری: این قانون روی همین سروری که Akhar را اجرا کردی اعمال می‌شود."
  pause
}

tcp_remove() {
  print_header
  read -rp "نام قانون برای حذف: " name
  name="$(sanitize_name "$name")"
  [[ -f "$(conf_path_tcp "$name")" ]] || { echo "❌ پیدا نشد."; pause; return; }

  rm -f "$(conf_path_tcp "$name")"
  apply_all
  echo "✅ حذف شد."
  pause
}

# ---------- HTTP reverse proxy ----------
http_add() {
  print_header
  require_nginx

  read -rp "نام قانون (مثال: panel): " name
  name="$(sanitize_name "$name")"
  [[ -n "$name" ]] || { echo "❌ نام خالی است."; pause; return; }
  [[ ! -f "$(conf_path_http "$name")" ]] || { echo "❌ این نام از قبل وجود دارد."; pause; return; }

  read -rp "دامنه (مثال: a.example.com): " domain
  [[ -n "$domain" ]] || { echo "❌ دامنه خالی است."; pause; return; }

  read -rp "IP مقصد داخل VPN (روی سرور مقابل) (مثال 10.10.10.2): " dst_ip
  [[ -n "$dst_ip" ]] || { echo "❌ IP خالی است."; pause; return; }

  read -rp "پورت HTTP روی سرور مقابل (مثال 8080): " dst_port
  [[ "$dst_port" =~ ^[0-9]+$ ]] || { echo "❌ پورت نامعتبر."; pause; return; }

  cat >"$(conf_path_http "$name")" <<EOF
TYPE=http
NAME=$name
DOMAIN=$domain
DST_IP=$dst_ip
DST_PORT=$dst_port
EOF
  chmod 600 "$(conf_path_http "$name")"

  cat >"$NGX_DIR/$name.conf" <<EOF
server {
  listen 80;
  server_name $domain;

  location / {
    proxy_http_version 1.1;
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto \$scheme;
    proxy_pass http://$dst_ip:$dst_port;
  }
}
EOF
  chmod 600 "$NGX_DIR/$name.conf"

  ensure_nginx_include
  nginx -t || { echo "❌ nginx config مشکل دارد."; pause; return; }
  systemctl reload nginx || true

  echo
  echo "✅ HTTP Proxy اضافه شد: http://$domain → http://$dst_ip:$dst_port"
  echo "نکته: برای HTTPS می‌توانی certbot اضافه کنی (در README توضیح داده شده)."
  pause
}

http_remove() {
  print_header
  require_nginx
  read -rp "نام قانون برای حذف: " name
  name="$(sanitize_name "$name")"
  [[ -f "$(conf_path_http "$name")" ]] || { echo "❌ پیدا نشد."; pause; return; }

  rm -f "$(conf_path_http "$name")" "$NGX_DIR/$name.conf"
  nginx -t && systemctl reload nginx || true
  echo "✅ حذف شد."
  pause
}

list_rules() {
  print_header
  echo "قوانین موجود:"
  echo "----------------------------------------------------------------"
  if compgen -G "$FWD_DIR/*" >/dev/null; then
    for f in "$FWD_DIR"/*; do
      echo "• $(basename "$f")"
      sed 's/^/   /' "$f" | head -n 30
      echo
    done
  else
    echo "(هیچ قانونی ثبت نشده)"
  fi
  echo "----------------------------------------------------------------"
  pause
}

show_state() {
  print_header
  load_state
  load_health
  echo "وضعیت فعلی:"
  echo "  VPN_IF=${VPN_IF:-<unset>}"
  echo "  PEER_IP=${PEER_IP:-<unset>}"
  echo
  echo "فایل‌ها:"
  echo "  $STATE_FILE"
  echo "  $HEALTH_FILE"
  pause
}

# ---------- Health check ----------
svc_active() {
  local s="$1"
  systemctl is-active --quiet "$s" 2>/dev/null
}

log_health() {
  local msg="$1"
  local ts
  ts="$(date -Is)"
  echo "[$ts] $msg" >>"$LOG_FILE" 2>/dev/null || true
  logger -t akhar "$msg" 2>/dev/null || true
}

run_alert() {
  load_health
  local msg="$1"
  log_health "ALERT: $msg"
  if [[ -n "${ALERT_CMD:-}" ]]; then
    # best-effort
    bash -lc "$ALERT_CMD" >/dev/null 2>&1 || true
  fi
}

health_check() {
  need_root
  ensure_dirs
  load_state
  load_health
  ensure_health_state

  local ok=1
  local reason=""

  if [[ -z "${VPN_IF:-}" ]]; then
    ok=0; reason="VPN_IF unset"
  elif ! ip link show "$VPN_IF" >/dev/null 2>&1; then
    ok=0; reason="VPN_IF not found: $VPN_IF"
  else
    local state
    state="$(ip -o link show "$VPN_IF" | awk '{print $9}')"
    if [[ "$state" != "UP" ]]; then
      ok=0; reason="interface down: $VPN_IF ($state)"
    fi
  fi

  if [[ "$ok" -eq 1 ]]; then
    # Has IPv4?
    if ! ip -4 addr show dev "$VPN_IF" | grep -q 'inet '; then
      ok=0; reason="no IPv4 on $VPN_IF"
    fi
  fi

  if [[ "$ok" -eq 1 && -n "${PEER_IP:-}" ]]; then
    if ! ping -I "$VPN_IF" -c "${PING_COUNT:-1}" -W "${PING_TIMEOUT:-1}" "$PEER_IP" >/dev/null 2>&1; then
      ok=0; reason="ping failed to PEER_IP=$PEER_IP via $VPN_IF"
    fi
  fi

  if [[ "$ok" -eq 1 && "${CHECK_SERVICES:-1}" == "1" ]]; then
    # Check if any of these exist and are active (best-effort)
    if systemctl list-unit-files | grep -q '^vpnserver\.service'; then
      svc_active vpnserver.service || { ok=0; reason="vpnserver.service not active"; }
    fi
    if [[ "$ok" -eq 1 ]] && systemctl list-unit-files | grep -q '^vpnclient\.service'; then
      svc_active vpnclient.service || { ok=0; reason="vpnclient.service not active"; }
    fi
  fi

  local threshold="${FAIL_THRESHOLD:-3}"
  if [[ "$ok" -eq 1 ]]; then
    if [[ "${FAILS:-0}" -ne 0 ]]; then
      log_health "RECOVERED (fails reset)."
    else
      log_health "OK."
    fi
    FAILS=0
    save_health_state
    exit 0
  else
    FAILS=$((FAILS + 1))
    save_health_state
    log_health "FAIL #$FAILS: $reason"
    if [[ "$FAILS" -ge "$threshold" ]]; then
      run_alert "SoftEther link unhealthy ($reason). FAILS=$FAILS"
    fi
    exit 1
  fi
}

# ---------- systemd units ----------
install_units() {
  need_root
  local bin="/usr/local/bin/Akhar"
  [[ -x "$bin" ]] || die "Akhar در $bin نصب نشده. اول: sudo install -m 755 Akhar /usr/local/bin/Akhar"

  cat >/etc/systemd/system/akhar-apply.service <<'EOF'
[Unit]
Description=Akhar apply nftables + reload nginx
After=network-online.target nftables.service
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/Akhar --apply

[Install]
WantedBy=multi-user.target
EOF

  cat >/etc/systemd/system/akhar-health.service <<'EOF'
[Unit]
Description=Akhar SoftEther health check
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/Akhar --health-check
EOF

  cat >/etc/systemd/system/akhar-health.timer <<'EOF'
[Unit]
Description=Run Akhar health check every minute

[Timer]
OnBootSec=45s
OnUnitActiveSec=60s
AccuracySec=10s
Unit=akhar-health.service

[Install]
WantedBy=timers.target
EOF

  systemctl daemon-reload
  systemctl enable akhar-apply.service >/dev/null 2>&1 || true
  systemctl enable --now akhar-health.timer >/dev/null 2>&1 || true

  echo "✅ systemd units نصب شد:"
  echo "  - akhar-apply.service (بوت)"
  echo "  - akhar-health.timer (هر 60 ثانیه)"
}

# ---------- Main menu ----------
menu() {
  while true; do
    print_header
    echo "تنظیمات:"
    echo "  1) انتخاب VPN_IF"
    echo "  2) تنظیم PEER_IP برای Health-Check"
    echo "  3) نمایش وضعیت"
    echo
    echo "TCP (Direct/Reverse):"
    echo "  4) افزودن TCP Port Forward (روی همین سرور)"
    echo "  5) حذف TCP Port Forward"
    echo
    echo "HTTP (Direct/Reverse):"
    echo "  6) افزودن HTTP Reverse Proxy (روی همین سرور)"
    echo "  7) حذف HTTP Reverse Proxy"
    echo
    echo "Health:"
    echo "  8) اجرای Health-Check (یک‌بار)"
    echo "  9) نصب systemd (apply + health timer)"
    echo
    echo "عمومی:"
    echo "  10) لیست قوانین"
    echo "  11) اعمال مجدد همه چیز (nft + nginx reload)"
    echo "  0) خروج"
    echo
    read -rp "انتخاب شما: " c
    case "$c" in
      1) pick_vpn_if ;;
      2) set_peer_ip ;;
      3) show_state ;;
      4) tcp_add ;;
      5) tcp_remove ;;
      6) http_add ;;
      7) http_remove ;;
      8) health_check; pause ;;
      9) install_units; pause ;;
      10) list_rules ;;
      11) apply_all; pause ;;
      0) exit 0 ;;
      *) echo "گزینه نامعتبر"; pause ;;
    esac
  done
}

# ---------- CLI ----------
case "${1:-}" in
  --apply)
    need_root
    apply_all
    exit 0
    ;;
  --health-check)
    health_check
    ;;
  --install-units)
    install_units
    exit 0
    ;;
esac

need_root
ensure_dirs
menu
