#!/usr/bin/env bash
set -Eeuo pipefail

# If piped, read from real TTY for prompts
if [[ ! -t 0 && -r /dev/tty ]]; then
  exec </dev/tty
fi

AKHAR_DIR="/etc/akhar"
FWD_DIR="$AKHAR_DIR/forwards.d"
NGX_DIR="$AKHAR_DIR/nginx.d"
NFT_FILE="$AKHAR_DIR/akhar.nft"
STATE_FILE="$AKHAR_DIR/state.env"
HEALTH_FILE="$AKHAR_DIR/health.env"
HEALTH_STATE="$AKHAR_DIR/health.state"
LOG_FILE="/var/log/akhar-health.log"

# ---------- UI ----------
print_header() {
  clear
  cat <<'ART'
    ___    _    _               _
   / _ \  | |  | |             | |
  / /_\ \ | | _| |__   __ _ _ __| |
  |  _  | | |/ / '_ \ / _` | '__| |
  | | | | |   <| | | | (_| | |  | |
  \_| |_/ |_|\_\_| |_|\__,_|_|  |_|

              Akhar
ART
  echo
  echo "Akhar - Full Bootstrap SoftEther + TCP Forward + HTTP Reverse + Health"
  echo "========================================================================"
  echo
}

pause() { echo; read -rp "Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Enter Ø¨Ø²Ù†ÛŒØ¯..."; }
die() { echo "âŒ $*"; exit 1; }
have() { command -v "$1" >/dev/null 2>&1; }
need_root() { [[ "${EUID:-$(id -u)}" -eq 0 ]] || die "Ø¨Ø§ root Ø§Ø¬Ø±Ø§ Ú©Ù†: sudo Akhar"; }

ensure_dirs() {
  mkdir -p "$FWD_DIR" "$NGX_DIR"
  chmod 700 "$AKHAR_DIR" "$FWD_DIR" "$NGX_DIR" || true
  touch "$LOG_FILE" >/dev/null 2>&1 || true
}

sanitize_name() {
  local n="$1"
  n="${n// /_}"
  n="$(echo "$n" | tr -c 'a-zA-Z0-9._-' '_' )"
  echo "$n"
}

require_nft() { have nft || die "nft Ù†ØµØ¨ Ù†ÛŒØ³Øª. (apt install nftables -y)"; }
require_nginx() { have nginx || die "nginx Ù†ØµØ¨ Ù†ÛŒØ³Øª. (apt install nginx -y)"; }

# ---------- State ----------
default_state() {
  cat >"$STATE_FILE" <<'EOF'
# Akhar state
VPN_IF=
ROLE=
PEER_PUBLIC_IP=
SOFTETHER_PORT=8443
HUB_NAME=QAZI
USER_NAME=irclient
# Stored for convenience (do NOT share publicly)
ADMIN_PASS=
HUB_PASS=
USER_PASS=
EOF
  chmod 600 "$STATE_FILE"
}

default_health() {
  cat >"$HEALTH_FILE" <<'EOF'
PEER_IP=
PING_COUNT=1
PING_TIMEOUT=1
FAIL_THRESHOLD=3
CHECK_SERVICES=1
ALERT_CMD=
EOF
  chmod 600 "$HEALTH_FILE"
}

load_state() { [[ -f "$STATE_FILE" ]] || default_state; source "$STATE_FILE"; }
load_health() { [[ -f "$HEALTH_FILE" ]] || default_health; source "$HEALTH_FILE"; }

ensure_health_state() {
  if [[ ! -f "$HEALTH_STATE" ]]; then
    echo "FAILS=0" >"$HEALTH_STATE"
    chmod 600 "$HEALTH_STATE"
  fi
  source "$HEALTH_STATE"
  : "${FAILS:=0}"
}

save_health_state() { echo "FAILS=${FAILS}" >"$HEALTH_STATE"; chmod 600 "$HEALTH_STATE"; }

# ---------- Firewall helper ----------
open_tcp_port() {
  local port="$1"
  if have ufw; then
    ufw allow "${port}/tcp" >/dev/null 2>&1 || true
  fi
}

# ---------- Nginx include ----------
ensure_nginx_include() {
  local inc="/etc/nginx/conf.d/akhar.conf"
  if [[ ! -f "$inc" ]]; then
    cat >"$inc" <<EOF
# Managed by Akhar
include $NGX_DIR/*.conf;
EOF
  fi
}

# ---------- Routing / nft ----------
enable_ip_forward() {
  sysctl -w net.ipv4.ip_forward=1 >/dev/null
  if [[ -w /etc/sysctl.conf ]] && ! grep -q '^net.ipv4.ip_forward=1' /etc/sysctl.conf; then
    echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
  fi
}

conf_path_tcp() { echo "$FWD_DIR/$1.tcp"; }
conf_path_http() { echo "$FWD_DIR/$1.http"; }

write_nft() {
  load_state
  [[ -n "${VPN_IF:-}" ]] || die "VPN_IF ØªÙ†Ø¸ÛŒÙ… Ù†ÛŒØ³Øª. Ø§Ø² Ù…Ù†Ùˆ: ØªÙ†Ø¸ÛŒÙ…Ø§Øª -> Ø§Ù†ØªØ®Ø§Ø¨ VPN_IF"

  {
    echo "#!/usr/sbin/nft -f"
    echo "# Generated by Akhar"
    echo "flush table inet akhar"
    echo "table inet akhar {"
    echo "  chain prerouting { type nat hook prerouting priority -100; policy accept;"
    if compgen -G "$FWD_DIR/*.tcp" >/dev/null; then
      for f in "$FWD_DIR"/*.tcp; do
        source "$f"
        [[ "${TYPE:-}" == "tcp" ]] || continue
        echo "    tcp dport ${PUB_PORT} dnat to ${DST_IP}:${DST_PORT} comment \"Akhar:${NAME}\""
      done
    fi
    echo "  }"
    echo "  chain postrouting { type nat hook postrouting priority 100; policy accept;"
    echo "    oifname \"${VPN_IF}\" masquerade comment \"Akhar:masq\""
    echo "  }"
    echo "  chain forward { type filter hook forward priority 0; policy drop;"
    echo "    ct state established,related accept"
    if compgen -G "$FWD_DIR/*.tcp" >/dev/null; then
      for f in "$FWD_DIR"/*.tcp; do
        source "$f"
        [[ "${TYPE:-}" == "tcp" ]] || continue
        echo "    ip daddr ${DST_IP} tcp dport ${DST_PORT} accept comment \"Akhar:${NAME}\""
      done
    fi
    echo "  }"
    echo "}"
  } >"$NFT_FILE"

  chmod 600 "$NFT_FILE"
}

apply_all() {
  require_nft
  ensure_dirs
  enable_ip_forward
  write_nft
  nft -f "$NFT_FILE"
  if have nginx; then
    nginx -t >/dev/null 2>&1 && systemctl reload nginx >/dev/null 2>&1 || true
  fi
  echo "âœ… Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯: nft rules + (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯) reload nginx"
}

# ---------- TCP forward ----------
tcp_add_noninteractive() {
  local name="$1" pub_port="$2" dst_ip="$3" dst_port="$4"
  name="$(sanitize_name "$name")"
  cat >"$(conf_path_tcp "$name")" <<EOF
TYPE=tcp
NAME=$name
PUB_PORT=$pub_port
DST_IP=$dst_ip
DST_PORT=$dst_port
EOF
  chmod 600 "$(conf_path_tcp "$name")"
}

tcp_add() {
  print_header
  load_state
  [[ -n "${VPN_IF:-}" ]] || { echo "âŒ Ø§ÙˆÙ„ VPN_IF Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†."; pause; return; }

  read -rp "Ù†Ø§Ù… Ù‚Ø§Ù†ÙˆÙ† (Ù…Ø«Ø§Ù„: ssh_peer): " name
  name="$(sanitize_name "$name")"
  [[ -n "$name" ]] || { echo "âŒ Ù†Ø§Ù… Ø®Ø§Ù„ÛŒ Ø§Ø³Øª."; pause; return; }
  [[ ! -f "$(conf_path_tcp "$name")" ]] || { echo "âŒ Ø§ÛŒÙ† Ù†Ø§Ù… Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯."; pause; return; }

  read -rp "Ù¾ÙˆØ±Øª Ø¹Ù…ÙˆÙ…ÛŒ Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø³Ø±ÙˆØ± (Ù…Ø«Ø§Ù„ 2222): " pub_port
  [[ "$pub_port" =~ ^[0-9]+$ ]] || { echo "âŒ Ù¾ÙˆØ±Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±."; pause; return; }

  read -rp "IP Ù…Ù‚ØµØ¯ Ø¯Ø§Ø®Ù„ VPN (Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ù…Ù‚Ø§Ø¨Ù„) (Ù…Ø«Ø§Ù„ 10.10.10.2): " dst_ip
  [[ -n "$dst_ip" ]] || { echo "âŒ IP Ø®Ø§Ù„ÛŒ Ø§Ø³Øª."; pause; return; }

  read -rp "Ù¾ÙˆØ±Øª Ù…Ù‚ØµØ¯ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ù…Ù‚Ø§Ø¨Ù„ (Ù…Ø«Ø§Ù„ 22): " dst_port
  [[ "$dst_port" =~ ^[0-9]+$ ]] || { echo "âŒ Ù¾ÙˆØ±Øª Ù…Ù‚ØµØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±."; pause; return; }

  tcp_add_noninteractive "$name" "$pub_port" "$dst_ip" "$dst_port"
  apply_all
  echo
  echo "âœ… TCP Forward Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: 0.0.0.0:${pub_port} â†’ ${dst_ip}:${dst_port}"
  pause
}

tcp_remove() {
  print_header
  read -rp "Ù†Ø§Ù… Ù‚Ø§Ù†ÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù: " name
  name="$(sanitize_name "$name")"
  [[ -f "$(conf_path_tcp "$name")" ]] || { echo "âŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯."; pause; return; }
  rm -f "$(conf_path_tcp "$name")"
  apply_all
  echo "âœ… Ø­Ø°Ù Ø´Ø¯."
  pause
}

# ---------- HTTP reverse proxy ----------
http_add_noninteractive() {
  local name="$1" domain="$2" dst_ip="$3" dst_port="$4"
  name="$(sanitize_name "$name")"
  cat >"$(conf_path_http "$name")" <<EOF
TYPE=http
NAME=$name
DOMAIN=$domain
DST_IP=$dst_ip
DST_PORT=$dst_port
EOF
  chmod 600 "$(conf_path_http "$name")"

  cat >"$NGX_DIR/$name.conf" <<EOF
server {
  listen 80;
  server_name $domain;

  location / {
    proxy_http_version 1.1;
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto \$scheme;
    proxy_pass http://$dst_ip:$dst_port;
  }
}
EOF
  chmod 600 "$NGX_DIR/$name.conf"
}

http_add() {
  print_header
  require_nginx

  read -rp "Ù†Ø§Ù… Ù‚Ø§Ù†ÙˆÙ† (Ù…Ø«Ø§Ù„: app_peer): " name
  name="$(sanitize_name "$name")"
  [[ -n "$name" ]] || { echo "âŒ Ù†Ø§Ù… Ø®Ø§Ù„ÛŒ Ø§Ø³Øª."; pause; return; }
  [[ ! -f "$(conf_path_http "$name")" ]] || { echo "âŒ Ø§ÛŒÙ† Ù†Ø§Ù… Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯."; pause; return; }

  read -rp "Ø¯Ø§Ù…Ù†Ù‡ (Ù…Ø«Ø§Ù„: a.example.com): " domain
  [[ -n "$domain" ]] || { echo "âŒ Ø¯Ø§Ù…Ù†Ù‡ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª."; pause; return; }

  read -rp "IP Ù…Ù‚ØµØ¯ Ø¯Ø§Ø®Ù„ VPN (Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ù…Ù‚Ø§Ø¨Ù„) (Ù…Ø«Ø§Ù„ 10.10.10.2): " dst_ip
  [[ -n "$dst_ip" ]] || { echo "âŒ IP Ø®Ø§Ù„ÛŒ Ø§Ø³Øª."; pause; return; }

  read -rp "Ù¾ÙˆØ±Øª HTTP Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ù…Ù‚Ø§Ø¨Ù„ (Ù…Ø«Ø§Ù„ 8080): " dst_port
  [[ "$dst_port" =~ ^[0-9]+$ ]] || { echo "âŒ Ù¾ÙˆØ±Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±."; pause; return; }

  http_add_noninteractive "$name" "$domain" "$dst_ip" "$dst_port"
  ensure_nginx_include
  nginx -t || { echo "âŒ nginx config Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯."; pause; return; }
  systemctl reload nginx || true
  echo
  echo "âœ… HTTP Proxy Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: http://$domain â†’ http://$dst_ip:$dst_port"
  pause
}

http_remove() {
  print_header
  require_nginx
  read -rp "Ù†Ø§Ù… Ù‚Ø§Ù†ÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù: " name
  name="$(sanitize_name "$name")"
  [[ -f "$(conf_path_http "$name")" ]] || { echo "âŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯."; pause; return; }
  rm -f "$(conf_path_http "$name")" "$NGX_DIR/$name.conf"
  nginx -t && systemctl reload nginx || true
  echo "âœ… Ø­Ø°Ù Ø´Ø¯."
  pause
}

# ---------- Health check ----------
svc_active() { systemctl is-active --quiet "$1" 2>/dev/null; }

log_health() {
  local msg="$1"
  local ts
  ts="$(date -Is)"
  echo "[$ts] $msg" >>"$LOG_FILE" 2>/dev/null || true
  logger -t akhar "$msg" 2>/dev/null || true
}

run_alert() {
  load_health
  local msg="$1"
  log_health "ALERT: $msg"
  if [[ -n "${ALERT_CMD:-}" ]]; then
    bash -lc "$ALERT_CMD" >/dev/null 2>&1 || true
  fi
}

health_check() {
  need_root
  ensure_dirs
  load_state
  load_health
  ensure_health_state

  local ok=1 reason=""

  if [[ -z "${VPN_IF:-}" ]]; then ok=0; reason="VPN_IF unset"
  elif ! ip link show "$VPN_IF" >/dev/null 2>&1; then ok=0; reason="VPN_IF not found"
  else
    local st; st="$(ip -o link show "$VPN_IF" | awk '{print $9}')"
    [[ "$st" == "UP" ]] || { ok=0; reason="interface down"; }
  fi

  if [[ "$ok" -eq 1 ]] && ! ip -4 addr show dev "$VPN_IF" | grep -q 'inet '; then
    ok=0; reason="no IPv4 on VPN_IF"
  fi

  if [[ "$ok" -eq 1 && -n "${PEER_IP:-}" ]]; then
    ping -I "$VPN_IF" -c "${PING_COUNT:-1}" -W "${PING_TIMEOUT:-1}" "$PEER_IP" >/dev/null 2>&1 || { ok=0; reason="ping failed"; }
  fi

  if [[ "$ok" -eq 1 && "${CHECK_SERVICES:-1}" == "1" ]]; then
    systemctl list-unit-files | grep -q '^vpnserver\.service' && ! svc_active vpnserver.service && { ok=0; reason="vpnserver down"; }
    systemctl list-unit-files | grep -q '^vpnclient\.service' && ! svc_active vpnclient.service && { ok=0; reason="vpnclient down"; }
  fi

  local threshold="${FAIL_THRESHOLD:-3}"
  if [[ "$ok" -eq 1 ]]; then
    [[ "${FAILS:-0}" -ne 0 ]] && log_health "RECOVERED"
    FAILS=0; save_health_state; log_health "OK"; exit 0
  else
    FAILS=$((FAILS+1)); save_health_state; log_health "FAIL #$FAILS: $reason"
    [[ "$FAILS" -ge "$threshold" ]] && run_alert "Link unhealthy ($reason), FAILS=$FAILS"
    exit 1
  fi
}

# ---------- systemd units ----------
install_units() {
  need_root
  [[ -x /usr/local/bin/Akhar ]] || die "Ø§ÙˆÙ„ Akhar Ø±Ø§ Ù†ØµØ¨ Ú©Ù†: install -m 755 Akhar /usr/local/bin/Akhar"

  cat >/etc/systemd/system/akhar-apply.service <<'EOF'
[Unit]
Description=Akhar apply nftables + reload nginx
After=network-online.target nftables.service
Wants=network-online.target
[Service]
Type=oneshot
ExecStart=/usr/local/bin/Akhar --apply
[Install]
WantedBy=multi-user.target
EOF

  cat >/etc/systemd/system/akhar-health.service <<'EOF'
[Unit]
Description=Akhar SoftEther health check
After=network-online.target
Wants=network-online.target
[Service]
Type=oneshot
ExecStart=/usr/local/bin/Akhar --health-check
EOF

  cat >/etc/systemd/system/akhar-health.timer <<'EOF'
[Unit]
Description=Run Akhar health check every minute
[Timer]
OnBootSec=45s
OnUnitActiveSec=60s
AccuracySec=10s
Unit=akhar-health.service
[Install]
WantedBy=timers.target
EOF

  systemctl daemon-reload
  systemctl enable akhar-apply.service >/dev/null 2>&1 || true
  systemctl enable --now akhar-health.timer >/dev/null 2>&1 || true

  echo "âœ… systemd units Ù†ØµØ¨ Ø´Ø¯ (apply Ø¯Ø± Ø¨ÙˆØª + health Ù‡Ø± 60 Ø«Ø§Ù†ÛŒÙ‡)."
}

# ---------- x-ui detection (local) ----------
detect_xui_port_local() {
  local port=""
  if systemctl list-unit-files 2>/dev/null | grep -q '^x-ui\.service'; then
    if systemctl is-active --quiet x-ui.service 2>/dev/null; then
      for p in 54321 2053 2083 2096 8443; do
        ss -lntp 2>/dev/null | grep -q ":$p " && { port="$p"; break; }
      done
      [[ -z "$port" ]] && port="54321"
    fi
  fi
  echo "$port"
}

# ---------- SoftEther install + systemd ----------
SOFTETHER_SERVER_URL="https://github.com/SoftEtherVPN/SoftEtherVPN_Stable/releases/latest/download/softether-vpnserver-v4.43-9799-rtm-2023.09.27-linux-x64-64bit.tar.gz"
SOFTETHER_CLIENT_URL="https://github.com/SoftEtherVPN/SoftEtherVPN_Stable/releases/latest/download/softether-vpnclient-v4.43-9799-rtm-2023.09.27-linux-x64-64bit.tar.gz"

install_softether_server() {
  have curl || die "curl Ù„Ø§Ø²Ù… Ø§Ø³Øª."
  local tmp="/tmp/softether.$RANDOM"
  mkdir -p "$tmp"
  apt update
  apt install -y build-essential libreadline-dev libssl-dev zlib1g-dev curl tar

  echo "â¬‡ï¸ SoftEther VPN Server downloadâ€¦"
  curl -fsSL "$SOFTETHER_SERVER_URL" -o "$tmp/server.tar.gz"
  tar -xzf "$tmp/server.tar.gz" -C "$tmp"

  [[ -d "$tmp/vpnserver" ]] || die "SoftEther server archive unexpected."
  pushd "$tmp/vpnserver" >/dev/null
  yes 1 | make >/dev/null
  popd >/dev/null

  rm -rf /usr/local/vpnserver
  mv "$tmp/vpnserver" /usr/local/vpnserver
  chmod 600 /usr/local/vpnserver/*
  chmod 700 /usr/local/vpnserver/vpnserver /usr/local/vpnserver/vpncmd

  rm -rf "$tmp"
  echo "âœ… SoftEther server Ù†ØµØ¨ Ø´Ø¯."
}

install_softether_client() {
  have curl || die "curl Ù„Ø§Ø²Ù… Ø§Ø³Øª."
  local tmp="/tmp/softether.$RANDOM"
  mkdir -p "$tmp"
  apt update
  apt install -y build-essential libreadline-dev libssl-dev zlib1g-dev curl tar

  echo "â¬‡ï¸ SoftEther VPN Client downloadâ€¦"
  curl -fsSL "$SOFTETHER_CLIENT_URL" -o "$tmp/client.tar.gz"
  tar -xzf "$tmp/client.tar.gz" -C "$tmp"

  [[ -d "$tmp/vpnclient" ]] || die "SoftEther client archive unexpected."
  pushd "$tmp/vpnclient" >/dev/null
  yes 1 | make >/dev/null
  popd >/dev/null

  rm -rf /usr/local/vpnclient
  mv "$tmp/vpnclient" /usr/local/vpnclient
  chmod 600 /usr/local/vpnclient/*
  chmod 700 /usr/local/vpnclient/vpnclient /usr/local/vpnclient/vpncmd

  rm -rf "$tmp"
  echo "âœ… SoftEther client Ù†ØµØ¨ Ø´Ø¯."
}

install_softether_units() {
  # server
  if [[ -x /usr/local/vpnserver/vpnserver ]]; then
    cat >/etc/systemd/system/vpnserver.service <<'EOF'
[Unit]
Description=SoftEther VPN Server
After=network.target
[Service]
Type=forking
ExecStart=/usr/local/vpnserver/vpnserver start
ExecStop=/usr/local/vpnserver/vpnserver stop
Restart=on-failure
[Install]
WantedBy=multi-user.target
EOF
  fi
  # client
  if [[ -x /usr/local/vpnclient/vpnclient ]]; then
    cat >/etc/systemd/system/vpnclient.service <<'EOF'
[Unit]
Description=SoftEther VPN Client
After=network.target
[Service]
Type=forking
ExecStart=/usr/local/vpnclient/vpnclient start
ExecStop=/usr/local/vpnclient/vpnclient stop
Restart=on-failure
[Install]
WantedBy=multi-user.target
EOF
  fi
  systemctl daemon-reload
}

# ---------- Bootstrap (FULL) ----------
pick_vpn_if() {
  print_header
  echo "Ø§ÛŒÙ†ØªØ±ÙÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:"
  ip -o link show | awk -F': ' '{print "â€¢ " $2}'
  echo
  read -rp "Ù†Ø§Ù… Ø§ÛŒÙ†ØªØ±ÙÛŒØ³ VPN (tap/vpn) Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø³Ø±ÙˆØ±: " vpnif
  [[ -n "$vpnif" ]] || return 1
  ip link show "$vpnif" >/dev/null 2>&1 || return 1
  sed -i "s/^VPN_IF=.*/VPN_IF=$vpnif/" "$STATE_FILE"
  echo "âœ… VPN_IF Ø«Ø¨Øª Ø´Ø¯: $vpnif"
  return 0
}

bootstrap() {
  need_root
  ensure_dirs
  load_state
  load_health

  print_header
  cat <<'TXT'
Bootstrap ÙÙˆÙ„:
- Ù†ØµØ¨ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§ (nftables + nginx)
- Ù†ØµØ¨ SoftEther (server ÛŒØ§ client)
- Ú©Ø§Ù†ÙÛŒÚ¯ Server/Client Ø¨Ø§ vpncmd
- Ù¾Ø±Ø³Ø´ Ø¯Ø±Ø¨Ø§Ø±Ù‡ x-ui (Ø±ÙˆÛŒ Ú©Ø¯Ø§Ù… Ø³Ø±ÙˆØ±) + Ø³Ø§Ø®Øª auto forward Ø§Ø®ØªÛŒØ§Ø±ÛŒ
- Ø³Ø§Ø®Øª Ù‚ÙˆØ§Ù†ÛŒÙ† TCP/HTTP Ø¨Ù‡ ØµÙˆØ±Øª Ù„ÛŒØ³ØªÛŒ
- ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ health-check Ùˆ systemd units
TXT
  echo

  echo "Ø§ÛŒÙ† Ø³Ø±ÙˆØ± Ú©Ø¬Ø§Ø³ØªØŸ"
  echo "  1) IR (Ø§ÛŒØ±Ø§Ù†)"
  echo "  2) OUT (Ø®Ø§Ø±Ø¬)"
  read -rp "Ø§Ù†ØªØ®Ø§Ø¨ (1/2): " role_sel
  local ROLE=""
  [[ "$role_sel" == "1" ]] && ROLE="IR"
  [[ "$role_sel" == "2" ]] && ROLE="OUT"
  [[ -n "$ROLE" ]] || die "Ù†Ù‚Ø´ Ù†Ø§Ù…Ø¹ØªØ¨Ø±."

  read -rp "IP Ø¹Ù…ÙˆÙ…ÛŒ Ø³Ø±ÙˆØ± Ù…Ù‚Ø§Ø¨Ù„: " PEER_PUBLIC_IP
  [[ -n "$PEER_PUBLIC_IP" ]] || die "IP Ù…Ù‚Ø§Ø¨Ù„ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª."

  read -rp "Ù¾ÙˆØ±Øª SoftEther (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ 8443): " SOFTETHER_PORT
  SOFTETHER_PORT="${SOFTETHER_PORT:-8443}"
  [[ "$SOFTETHER_PORT" =~ ^[0-9]+$ ]] || die "Ù¾ÙˆØ±Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±."

  read -rp "Ù†Ø§Ù… HUB (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ QAZI): " HUB_NAME
  HUB_NAME="${HUB_NAME:-QAZI}"

  read -rp "Ù†Ø§Ù… ÛŒÙˆØ²Ø± (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ irclient): " USER_NAME
  USER_NAME="${USER_NAME:-irclient}"

  echo
  read -rp "Ù¾Ø³ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ† SoftEther (Ø®Ø§Ù„ÛŒ=ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±): " ADMIN_PASS
  if [[ -z "$ADMIN_PASS" ]]; then
    ADMIN_PASS="$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 16)"
    echo "ğŸ” ADMIN_PASS: $ADMIN_PASS"
  fi
  read -rp "Ù¾Ø³ÙˆØ±Ø¯ HUB (Ø®Ø§Ù„ÛŒ=ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±): " HUB_PASS
  if [[ -z "$HUB_PASS" ]]; then
    HUB_PASS="$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 16)"
    echo "ğŸ” HUB_PASS: $HUB_PASS"
  fi
  read -rp "Ù¾Ø³ÙˆØ±Ø¯ ÛŒÙˆØ²Ø± (Ø®Ø§Ù„ÛŒ=ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±): " USER_PASS
  if [[ -z "$USER_PASS" ]]; then
    USER_PASS="$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 16)"
    echo "ğŸ” USER_PASS: $USER_PASS"
  fi

  echo
  echo "ğŸ“¦ Ù†ØµØ¨ Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø²Ù‡Ø§â€¦"
  apt update
  apt install -y nftables nginx curl tar
  systemctl enable --now nftables

  echo
  echo "ğŸ“¦ Ù†ØµØ¨ SoftEtherâ€¦"
  if [[ "$ROLE" == "OUT" ]]; then
    [[ -x /usr/local/vpnserver/vpnserver ]] || install_softether_server
  else
    [[ -x /usr/local/vpnclient/vpnclient ]] || install_softether_client
  fi
  install_softether_units

  # Save state
  sed -i "s/^ROLE=.*/ROLE=$ROLE/" "$STATE_FILE"
  sed -i "s/^PEER_PUBLIC_IP=.*/PEER_PUBLIC_IP=$PEER_PUBLIC_IP/" "$STATE_FILE"
  sed -i "s/^SOFTETHER_PORT=.*/SOFTETHER_PORT=$SOFTETHER_PORT/" "$STATE_FILE"
  sed -i "s/^HUB_NAME=.*/HUB_NAME=$HUB_NAME/" "$STATE_FILE"
  sed -i "s/^USER_NAME=.*/USER_NAME=$USER_NAME/" "$STATE_FILE"
  sed -i "s/^ADMIN_PASS=.*/ADMIN_PASS=$ADMIN_PASS/" "$STATE_FILE"
  sed -i "s/^HUB_PASS=.*/HUB_PASS=$HUB_PASS/" "$STATE_FILE"
  sed -i "s/^USER_PASS=.*/USER_PASS=$USER_PASS/" "$STATE_FILE"

  if [[ "$ROLE" == "OUT" ]]; then
    echo
    echo "â–¶ï¸ Ú©Ø§Ù†ÙÛŒÚ¯ VPN Serverâ€¦"
    systemctl enable --now vpnserver.service

    /usr/local/vpnserver/vpncmd localhost /SERVER /CMD ServerPasswordSet "$ADMIN_PASS" >/dev/null
    /usr/local/vpnserver/vpncmd localhost /SERVER /CMD HubCreate "$HUB_NAME" /PASSWORD:"$HUB_PASS" >/dev/null 2>&1 || true
    /usr/local/vpnserver/vpncmd localhost /SERVER /HUB:"$HUB_NAME" /CMD UserCreate "$USER_NAME" >/dev/null 2>&1 || true
    /usr/local/vpnserver/vpncmd localhost /SERVER /HUB:"$HUB_NAME" /CMD UserPasswordSet "$USER_NAME" /PASSWORD:"$USER_PASS" >/dev/null

    /usr/local/vpnserver/vpncmd localhost /SERVER /CMD ListenerDelete 5555 >/dev/null 2>&1 || true
    /usr/local/vpnserver/vpncmd localhost /SERVER /CMD ListenerDelete 992 >/dev/null 2>&1 || true
    /usr/local/vpnserver/vpncmd localhost /SERVER /CMD ListenerCreate "$SOFTETHER_PORT" >/dev/null 2>&1 || true

    /usr/local/vpnserver/vpncmd localhost /SERVER /HUB:"$HUB_NAME" /CMD SecureNatEnable >/dev/null 2>&1 || true

    open_tcp_port "$SOFTETHER_PORT"
    echo "âœ… Server Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯. Ù¾ÙˆØ±Øª TCP/$SOFTETHER_PORT Ø¨Ø§ÛŒØ¯ Ø§Ø² Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø§Ø² Ø¨Ø§Ø´Ø¯."
  else
    echo
    echo "â–¶ï¸ Ú©Ø§Ù†ÙÛŒÚ¯ VPN Clientâ€¦"
    systemctl enable --now vpnclient.service

    /usr/local/vpnclient/vpncmd localhost /CLIENT /CMD NicCreate qaznic >/dev/null 2>&1 || true
    /usr/local/vpnclient/vpncmd localhost /CLIENT /CMD AccountCreate qazacc /SERVER:"$PEER_PUBLIC_IP":"$SOFTETHER_PORT" /HUB:"$HUB_NAME" /USERNAME:"$USER_NAME" /NICNAME:qaznic >/dev/null 2>&1 || true
    /usr/local/vpnclient/vpncmd localhost /CLIENT /CMD AccountPasswordSet qazacc /PASSWORD:"$USER_PASS" >/dev/null
    /usr/local/vpnclient/vpncmd localhost /CLIENT /CMD AccountConnect qazacc >/dev/null 2>&1 || true

    echo "âœ… Client Ø¯Ø³ØªÙˆØ± Ø§ØªØµØ§Ù„ Ø±Ø§ Ø¯Ø§Ø¯. ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø¨Ø§ vpncmd Ú†Ú© Ú©Ù†ÛŒ."
  fi

  echo
  echo "Ø§Ú©Ù†ÙˆÙ† Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ ÛŒÚ© Ø§ÛŒÙ†ØªØ±ÙÛŒØ³ Ø¬Ø¯ÛŒØ¯ (tap/vpn) Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡."
  read -rp "Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø§Ù„Ø§Ù† VPN_IF Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒÙ…ØŸ (y/n): " yn
  if [[ "$yn" =~ ^[Yy]$ ]]; then
    pick_vpn_if || echo "âš ï¸ Ù†ØªÙˆÙ†Ø³ØªÙ… VPN_IF Ø±Ø§ Ø³Øª Ú©Ù†Ù…. Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ø² Ù…Ù†Ùˆ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡."
  fi

  echo
  read -rp "IP Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ Ø¯Ø§Ø®Ù„ VPN Ø¨Ø±Ø§ÛŒ Health-Check (PEER_IP) (Ù…Ø«Ø§Ù„ 10.10.10.2): " peer_vpn_ip
  [[ -n "$peer_vpn_ip" ]] && sed -i "s/^PEER_IP=.*/PEER_IP=$peer_vpn_ip/" "$HEALTH_FILE" || true

  # x-ui logic
  echo
  echo "Ù¾Ù†Ù„ x-ui Ø±ÙˆÛŒ Ú©Ø¯Ø§Ù… Ø³Ø±ÙˆØ± Ø§Ø³ØªØŸ"
  echo "  1) Ù‡Ù…ÛŒÙ† Ø³Ø±ÙˆØ±"
  echo "  2) Ø³Ø±ÙˆØ± Ù…Ù‚Ø§Ø¨Ù„"
  echo "  3) Ù†Ø¯Ø§Ø±Ù…/Ù…Ù‡Ù… Ù†ÛŒØ³Øª"
  local xui_where=""
  read -rp "Ø§Ù†ØªØ®Ø§Ø¨ (1/2/3): " xsel
  if [[ "$xsel" == "1" ]]; then xui_where="LOCAL"
  elif [[ "$xsel" == "2" ]]; then xui_where="PEER"
  else xui_where="NONE"; fi

  local xui_port_local=""
  if [[ "$xui_where" == "LOCAL" ]]; then
    xui_port_local="$(detect_xui_port_local)"
    if [[ -n "$xui_port_local" ]]; then
      echo "âœ… x-ui Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø³Ø±ÙˆØ± Ù¾ÛŒØ¯Ø§ Ø´Ø¯. Ù¾ÙˆØ±Øª Ø§Ø­ØªÙ…Ø§Ù„ÛŒ: $xui_port_local"
    else
      echo "âš ï¸ x-ui Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø³Ø±ÙˆØ± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ (ÛŒØ§ Ø³Ø±ÙˆÛŒØ³Ø´ Ù†Ø§Ù…Ø´ Ù…ØªÙØ§ÙˆØª Ø§Ø³Øª)."
      read -rp "Ù¾ÙˆØ±Øª Ù¾Ù†Ù„ Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø³Ø±ÙˆØ± (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ 54321): " xui_port_local
      xui_port_local="${xui_port_local:-54321}"
    fi
  fi

  if [[ "$xui_where" == "PEER" && -n "$peer_vpn_ip" ]]; then
    read -rp "Ù¾ÙˆØ±Øª Ù¾Ù†Ù„ x-ui Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ù…Ù‚Ø§Ø¨Ù„ (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ 54321): " xui_peer_port
    xui_peer_port="${xui_peer_port:-54321}"
    read -rp "Ù¾ÙˆØ±Øª Ø¹Ù…ÙˆÙ…ÛŒ Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ù†Ù„ (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ 15432): " pubx
    pubx="${pubx:-15432}"
    if [[ -n "${VPN_IF:-}" ]]; then
      tcp_add_noninteractive "xui_panel" "$pubx" "$peer_vpn_ip" "$xui_peer_port"
      echo "âœ… Forward Ù¾Ù†Ù„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: :$pubx â†’ $peer_vpn_ip:$xui_peer_port"
    else
      echo "âš ï¸ Ú†ÙˆÙ† VPN_IF Ø³Øª Ù†Ø´Ø¯Ù‡ØŒ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø±Ø§ Ø§Ù„Ø§Ù† Ø§Ø¹Ù…Ø§Ù„ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ù…. Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†."
    fi
  fi

  echo
  echo "Ø§ÙØ²ÙˆØ¯Ù† Ù‚ÙˆØ§Ù†ÛŒÙ† TCP (ÙØ±Ù…Øª: public_port:dst_ip:dst_port). Ø®Ø§Ù„ÛŒ=Ø§ØªÙ…Ø§Ù…"
  while true; do
    read -rp "TCP rule: " line
    [[ -z "$line" ]] && break
    IFS=':' read -r pp dip dp <<<"$line"
    if [[ ! "$pp" =~ ^[0-9]+$ || -z "${dip:-}" || ! "$dp" =~ ^[0-9]+$ ]]; then
      echo "ÙØ±Ù…Øª ØºÙ„Ø·. Ù…Ø«Ø§Ù„: 2222:10.10.10.2:22"
      continue
    fi
    tcp_add_noninteractive "tcp_${pp}_${dp}" "$pp" "$dip" "$dp"
    echo "âœ… :$pp â†’ $dip:$dp"
  done

  if have nginx; then
    ensure_nginx_include
    echo
    echo "Ø§ÙØ²ÙˆØ¯Ù† Ù‚ÙˆØ§Ù†ÛŒÙ† HTTP (ÙØ±Ù…Øª: domain:dst_ip:dst_port). Ø®Ø§Ù„ÛŒ=Ø§ØªÙ…Ø§Ù…"
    while true; do
      read -rp "HTTP rule: " line
      [[ -z "$line" ]] && break
      IFS=':' read -r dom dip dp <<<"$line"
      if [[ -z "${dom:-}" || -z "${dip:-}" || ! "$dp" =~ ^[0-9]+$ ]]; then
        echo "ÙØ±Ù…Øª ØºÙ„Ø·. Ù…Ø«Ø§Ù„: app.example.com:10.10.10.2:8080"
        continue
      fi
      http_add_noninteractive "http_${dp}" "$dom" "$dip" "$dp"
      echo "âœ… http://$dom â†’ $dip:$dp"
    done
  fi

  if [[ -n "${VPN_IF:-}" ]]; then
    apply_all
    have nginx && nginx -t && systemctl reload nginx || true
  else
    echo "âš ï¸ VPN_IF Ø³Øª Ù†Ø´Ø¯Ù‡Ø› Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ø² Ù…Ù†Ùˆ Ú¯Ø²ÛŒÙ†Ù‡ Apply Ø±Ø§ Ø¨Ø²Ù†."
  fi

  echo
  read -rp "systemd units (apply+health timer) Ù†ØµØ¨ Ø´ÙˆØ¯ØŸ (y/n): " su
  [[ "$su" =~ ^[Yy]$ ]] && install_units || true

  echo
  echo "ğŸ‰ Bootstrap ØªÙ…Ø§Ù… Ø´Ø¯."
  echo "Ù¾Ø³ÙˆØ±Ø¯Ù‡Ø§ Ø¯Ø§Ø®Ù„ $STATE_FILE Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ (Ù…Ø¬ÙˆØ² 600)."
  pause
}

# ---------- Settings menus ----------
pick_vpn_if_menu() { pick_vpn_if || echo "âŒ"; pause; }

set_peer_ip_menu() {
  print_header
  load_health
  read -rp "PEER_IP (IP Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ Ø¯Ø§Ø®Ù„ VPN): " pip
  sed -i "s/^PEER_IP=.*/PEER_IP=${pip}/" "$HEALTH_FILE"
  echo "âœ… Ø«Ø¨Øª Ø´Ø¯."
  pause
}

show_state() {
  print_header
  load_state; load_health
  echo "STATE:"
  sed 's/^\(.*PASS=.*\)$/\1 (stored)/' "$STATE_FILE" | sed 's/^/  /'
  echo
  echo "HEALTH:"
  sed 's/^/  /' "$HEALTH_FILE"
  pause
}

list_rules() {
  print_header
  echo "Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…ÙˆØ¬ÙˆØ¯:"
  echo "----------------------------------------------------------------"
  if compgen -G "$FWD_DIR/*" >/dev/null; then
    for f in "$FWD_DIR"/*; do
      echo "â€¢ $(basename "$f")"
      sed 's/^/   /' "$f" | head -n 40
      echo
    done
  else
    echo "(Ù‡ÛŒÚ† Ù‚Ø§Ù†ÙˆÙ†ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡)"
  fi
  echo "----------------------------------------------------------------"
  pause
}

# ---------- Main menu ----------
menu() {
  while true; do
    print_header
    echo "1) Bootstrap ÙÙˆÙ„ (Ù†ØµØ¨/Ú©Ø§Ù†ÙÛŒÚ¯ SoftEther + auto forward)"
    echo
    echo "ØªÙ†Ø¸ÛŒÙ…Ø§Øª:"
    echo "2) Ø§Ù†ØªØ®Ø§Ø¨ VPN_IF"
    echo "3) ØªÙ†Ø¸ÛŒÙ… PEER_IP Ø¨Ø±Ø§ÛŒ Health-Check"
    echo "4) Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª"
    echo
    echo "TCP:"
    echo "5) Ø§ÙØ²ÙˆØ¯Ù† TCP Port Forward"
    echo "6) Ø­Ø°Ù TCP Port Forward"
    echo
    echo "HTTP:"
    echo "7) Ø§ÙØ²ÙˆØ¯Ù† HTTP Reverse Proxy"
    echo "8) Ø­Ø°Ù HTTP Reverse Proxy"
    echo
    echo "Health:"
    echo "9) Health-Check (ÛŒÚ©Ø¨Ø§Ø±)"
    echo "10) Ù†ØµØ¨ systemd units (apply + health timer)"
    echo
    echo "Ø¹Ù…ÙˆÙ…ÛŒ:"
    echo "11) Ù„ÛŒØ³Øª Ù‚ÙˆØ§Ù†ÛŒÙ†"
    echo "12) Ø§Ø¹Ù…Ø§Ù„ Ù…Ø¬Ø¯Ø¯ (nft + nginx reload)"
    echo "0) Ø®Ø±ÙˆØ¬"
    echo
    read -rp "Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§: " c
    case "$c" in
      1) bootstrap ;;
      2) pick_vpn_if_menu ;;
      3) set_peer_ip_menu ;;
      4) show_state ;;
      5) tcp_add ;;
      6) tcp_remove ;;
      7) http_add ;;
      8) http_remove ;;
      9) health_check; pause ;;
      10) install_units; pause ;;
      11) list_rules ;;
      12) apply_all; pause ;;
      0) exit 0 ;;
      *) echo "Ú¯Ø²ÛŒÙ†Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±"; pause ;;
    esac
  done
}

# ---------- CLI ----------
case "${1:-}" in
  --bootstrap) bootstrap; exit 0 ;;
  --apply) need_root; apply_all; exit 0 ;;
  --health-check) health_check ;;
  --install-units) install_units; exit 0 ;;
esac

need_root
ensure_dirs
menu
