#!/usr/bin/env bash
set -Eeuo pipefail
if [[ ! -t 0 && -r /dev/tty ]]; then exec </dev/tty; fi

AKHAR_DIR="/etc/akhar"
FWD_DIR="$AKHAR_DIR/forwards.d"
NGX_DIR="$AKHAR_DIR/nginx.d"
NFT_FILE="$AKHAR_DIR/akhar.nft"
STATE_FILE="$AKHAR_DIR/state.env"
HEALTH_FILE="$AKHAR_DIR/health.env"
HEALTH_STATE="$AKHAR_DIR/health.state"
LOG_FILE="/var/log/akhar-health.log"

print_header() {
  clear
  cat <<'ART'
    ___    _    _               _
   / _ \  | |  | |             | |
  / /_\ \ | | _| |__   __ _ _ __| |
  |  _  | | |/ / '_ \ / _` | '__| |
  | | | | |   <| | | | (_| | |  | |
  \_| |_/ |_|\_\_| |_|\__,_|_|  |_|

              Akhar
ART
  echo
  echo "Akhar - FAST Bootstrap (APT SoftEther) + TCP Forward + HTTP Reverse + Health"
  echo "============================================================================"
  echo
}

pause(){ echo; read -rp "Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Enter Ø¨Ø²Ù†ÛŒØ¯..."; }
die(){ echo "âŒ $*"; exit 1; }
have(){ command -v "$1" >/dev/null 2>&1; }
need_root(){ [[ "${EUID:-$(id -u)}" -eq 0 ]] || die "Ø¨Ø§ root Ø§Ø¬Ø±Ø§ Ú©Ù†: sudo Akhar"; }

ensure_dirs(){
  mkdir -p "$FWD_DIR" "$NGX_DIR"
  chmod 700 "$AKHAR_DIR" "$FWD_DIR" "$NGX_DIR" || true
  touch "$LOG_FILE" >/dev/null 2>&1 || true
}

sanitize_name(){
  local n="$1"; n="${n// /_}"
  n="$(echo "$n" | tr -c 'a-zA-Z0-9._-' '_' )"
  echo "$n"
}

default_state(){
cat >"$STATE_FILE" <<'EOF'
VPN_IF=
ROLE=
PEER_PUBLIC_IP=
SOFTETHER_PORT=8443
HUB_NAME=QAZI
USER_NAME=irclient
ADMIN_PASS=
HUB_PASS=
USER_PASS=
EOF
chmod 600 "$STATE_FILE"
}

default_health(){
cat >"$HEALTH_FILE" <<'EOF'
PEER_IP=
PING_COUNT=1
PING_TIMEOUT=1
FAIL_THRESHOLD=3
CHECK_SERVICES=1
ALERT_CMD=
EOF
chmod 600 "$HEALTH_FILE"
}

load_state(){ [[ -f "$STATE_FILE" ]] || default_state; source "$STATE_FILE"; }
load_health(){ [[ -f "$HEALTH_FILE" ]] || default_health; source "$HEALTH_FILE"; }

ensure_health_state(){
  if [[ ! -f "$HEALTH_STATE" ]]; then echo "FAILS=0" >"$HEALTH_STATE"; chmod 600 "$HEALTH_STATE"; fi
  source "$HEALTH_STATE"; : "${FAILS:=0}"
}
save_health_state(){ echo "FAILS=${FAILS}" >"$HEALTH_STATE"; chmod 600 "$HEALTH_STATE"; }

require_nft(){ have nft || die "nft Ù†ØµØ¨ Ù†ÛŒØ³Øª. apt install nftables -y"; }
require_nginx(){ have nginx || die "nginx Ù†ØµØ¨ Ù†ÛŒØ³Øª. apt install nginx -y"; }

open_tcp_port(){
  local port="$1"
  if have ufw; then ufw allow "${port}/tcp" >/dev/null 2>&1 || true; fi
}

enable_ip_forward(){
  sysctl -w net.ipv4.ip_forward=1 >/dev/null
  if [[ -w /etc/sysctl.conf ]] && ! grep -q '^net.ipv4.ip_forward=1' /etc/sysctl.conf; then
    echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
  fi
}

conf_path_tcp(){ echo "$FWD_DIR/$1.tcp"; }
conf_path_http(){ echo "$FWD_DIR/$1.http"; }

write_nft(){
  load_state
  [[ -n "${VPN_IF:-}" ]] || die "VPN_IF ØªÙ†Ø¸ÛŒÙ… Ù†ÛŒØ³Øª."
  {
    echo "#!/usr/sbin/nft -f"
    echo "flush table inet akhar"
    echo "table inet akhar {"
    echo "  chain prerouting { type nat hook prerouting priority -100; policy accept;"
    if compgen -G "$FWD_DIR/*.tcp" >/dev/null; then
      for f in "$FWD_DIR"/*.tcp; do
        source "$f"; [[ "${TYPE:-}" == "tcp" ]] || continue
        echo "    tcp dport ${PUB_PORT} dnat to ${DST_IP}:${DST_PORT} comment \"Akhar:${NAME}\""
      done
    fi
    echo "  }"
    echo "  chain postrouting { type nat hook postrouting priority 100; policy accept;"
    echo "    oifname \"${VPN_IF}\" masquerade comment \"Akhar:masq\""
    echo "  }"
    echo "  chain forward { type filter hook forward priority 0; policy drop;"
    echo "    ct state established,related accept"
    if compgen -G "$FWD_DIR/*.tcp" >/dev/null; then
      for f in "$FWD_DIR"/*.tcp; do
        source "$f"; [[ "${TYPE:-}" == "tcp" ]] || continue
        echo "    ip daddr ${DST_IP} tcp dport ${DST_PORT} accept comment \"Akhar:${NAME}\""
      done
    fi
    echo "  }"
    echo "}"
  } >"$NFT_FILE"
  chmod 600 "$NFT_FILE"
}

apply_all(){
  require_nft
  ensure_dirs
  enable_ip_forward
  write_nft
  nft -f "$NFT_FILE"
  if have nginx; then nginx -t >/dev/null 2>&1 && systemctl reload nginx >/dev/null 2>&1 || true; fi
  echo "âœ… Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯."
}

tcp_add_noninteractive(){
  local name="$1" pub_port="$2" dst_ip="$3" dst_port="$4"
  name="$(sanitize_name "$name")"
  cat >"$(conf_path_tcp "$name")" <<EOF
TYPE=tcp
NAME=$name
PUB_PORT=$pub_port
DST_IP=$dst_ip
DST_PORT=$dst_port
EOF
  chmod 600 "$(conf_path_tcp "$name")"
}

ensure_nginx_include(){
  local inc="/etc/nginx/conf.d/akhar.conf"
  [[ -f "$inc" ]] || cat >"$inc" <<EOF
# Managed by Akhar
include $NGX_DIR/*.conf;
EOF
}

http_add_noninteractive(){
  local name="$1" domain="$2" dst_ip="$3" dst_port="$4"
  name="$(sanitize_name "$name")"
  cat >"$(conf_path_http "$name")" <<EOF
TYPE=http
NAME=$name
DOMAIN=$domain
DST_IP=$dst_ip
DST_PORT=$dst_port
EOF
  chmod 600 "$(conf_path_http "$name")"
  mkdir -p "$NGX_DIR"
  cat >"$NGX_DIR/$name.conf" <<EOF
server {
  listen 80;
  server_name $domain;
  location / {
    proxy_http_version 1.1;
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto \$scheme;
    proxy_pass http://$dst_ip:$dst_port;
  }
}
EOF
  chmod 600 "$NGX_DIR/$name.conf"
  ensure_nginx_include
}

svc_active(){ systemctl is-active --quiet "$1" 2>/dev/null; }
log_health(){
  local msg="$1" ts; ts="$(date -Is)"
  echo "[$ts] $msg" >>"$LOG_FILE" 2>/dev/null || true
  logger -t akhar "$msg" 2>/dev/null || true
}
run_alert(){
  load_health
  local msg="$1"
  log_health "ALERT: $msg"
  [[ -n "${ALERT_CMD:-}" ]] && bash -lc "$ALERT_CMD" >/dev/null 2>&1 || true
}
health_check(){
  need_root; ensure_dirs; load_state; load_health; ensure_health_state
  local ok=1 reason=""
  if [[ -z "${VPN_IF:-}" ]]; then ok=0; reason="VPN_IF unset"
  elif ! ip link show "$VPN_IF" >/dev/null 2>&1; then ok=0; reason="VPN_IF not found"
  else
    local st; st="$(ip -o link show "$VPN_IF" | awk '{print $9}')"
    [[ "$st" == "UP" ]] || { ok=0; reason="interface down"; }
  fi
  if [[ "$ok" -eq 1 ]] && ! ip -4 addr show dev "$VPN_IF" | grep -q 'inet '; then ok=0; reason="no IPv4"; fi
  if [[ "$ok" -eq 1 && -n "${PEER_IP:-}" ]]; then
    ping -I "$VPN_IF" -c "${PING_COUNT:-1}" -W "${PING_TIMEOUT:-1}" "$PEER_IP" >/dev/null 2>&1 || { ok=0; reason="ping failed"; }
  fi
  if [[ "$ok" -eq 1 && "${CHECK_SERVICES:-1}" == "1" ]]; then
    systemctl list-unit-files | grep -q '^softether-vpnserver\.service' && ! svc_active softether-vpnserver.service && { ok=0; reason="softether-vpnserver down"; }
    systemctl list-unit-files | grep -q '^softether-vpnclient\.service' && ! svc_active softether-vpnclient.service && { ok=0; reason="softether-vpnclient down"; }
  fi
  local threshold="${FAIL_THRESHOLD:-3}"
  if [[ "$ok" -eq 1 ]]; then
    [[ "${FAILS:-0}" -ne 0 ]] && log_health "RECOVERED"
    FAILS=0; save_health_state; log_health "OK"; exit 0
  else
    FAILS=$((FAILS+1)); save_health_state; log_health "FAIL #$FAILS: $reason"
    [[ "$FAILS" -ge "$threshold" ]] && run_alert "Link unhealthy ($reason), FAILS=$FAILS"
    exit 1
  fi
}

install_units(){
  need_root
  [[ -x /usr/local/bin/Akhar ]] || die "Akhar Ù†ØµØ¨ Ù†ÛŒØ³Øª."
  cat >/etc/systemd/system/akhar-apply.service <<'EOF'
[Unit]
Description=Akhar apply nftables + reload nginx
After=network-online.target nftables.service
Wants=network-online.target
[Service]
Type=oneshot
ExecStart=/usr/local/bin/Akhar --apply
[Install]
WantedBy=multi-user.target
EOF
  cat >/etc/systemd/system/akhar-health.service <<'EOF'
[Unit]
Description=Akhar SoftEther health check
After=network-online.target
Wants=network-online.target
[Service]
Type=oneshot
ExecStart=/usr/local/bin/Akhar --health-check
EOF
  cat >/etc/systemd/system/akhar-health.timer <<'EOF'
[Unit]
Description=Run Akhar health check every minute
[Timer]
OnBootSec=45s
OnUnitActiveSec=60s
AccuracySec=10s
Unit=akhar-health.service
[Install]
WantedBy=timers.target
EOF
  systemctl daemon-reload
  systemctl enable akhar-apply.service >/dev/null 2>&1 || true
  systemctl enable --now akhar-health.timer >/dev/null 2>&1 || true
  echo "âœ… systemd units Ù†ØµØ¨ Ø´Ø¯."
}

detect_xui_port_local(){
  local port=""
  if systemctl list-unit-files 2>/dev/null | grep -q '^x-ui\.service'; then
    if systemctl is-active --quiet x-ui.service 2>/dev/null; then
      for p in 54321 2053 2083 2096 8443; do
        ss -lntp 2>/dev/null | grep -q ":$p " && { port="$p"; break; }
      done
      [[ -z "$port" ]] && port="54321"
    fi
  fi
  echo "$port"
}

apt_has_pkg(){ apt-cache show "$1" >/dev/null 2>&1; }

install_softether_server_apt(){
  echo "ğŸ“¦ Installing softether-vpnserver via APTâ€¦"
  apt update
  apt install -y softether-vpnserver
  systemctl enable --now softether-vpnserver.service
}

install_softether_client_apt(){
  echo "ğŸ“¦ Installing softether-vpnclient via APTâ€¦"
  apt update
  apt install -y softether-vpnclient
  systemctl enable --now softether-vpnclient.service
}

pick_vpn_if(){
  print_header
  echo "Ø§ÛŒÙ†ØªØ±ÙÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:"
  ip -o link show | awk -F': ' '{print "â€¢ " $2}'
  echo
  read -rp "Ù†Ø§Ù… Ø§ÛŒÙ†ØªØ±ÙÛŒØ³ VPN (tap/vpn) Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø³Ø±ÙˆØ±: " vpnif
  [[ -n "$vpnif" ]] || return 1
  ip link show "$vpnif" >/dev/null 2>&1 || return 1
  sed -i "s/^VPN_IF=.*/VPN_IF=$vpnif/" "$STATE_FILE"
  echo "âœ… VPN_IF Ø«Ø¨Øª Ø´Ø¯: $vpnif"
  return 0
}

bootstrap(){
  need_root; ensure_dirs; load_state; load_health
  print_header
  echo "Bootstrap Ø³Ø±ÛŒØ¹: SoftEther Ø§Ø² APT Ù†ØµØ¨ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (Ø¨Ø¯ÙˆÙ† Ú©Ø§Ù…Ù¾Ø§ÛŒÙ„)."
  echo

  echo "Ø§ÛŒÙ† Ø³Ø±ÙˆØ± Ú©Ø¬Ø§Ø³ØªØŸ"
  echo "  1) IR (Ø§ÛŒØ±Ø§Ù†)"
  echo "  2) OUT (Ø®Ø§Ø±Ø¬)"
  read -rp "Ø§Ù†ØªØ®Ø§Ø¨ (1/2): " role_sel
  local ROLE=""
  [[ "$role_sel" == "1" ]] && ROLE="IR"
  [[ "$role_sel" == "2" ]] && ROLE="OUT"
  [[ -n "$ROLE" ]] || die "Ù†Ù‚Ø´ Ù†Ø§Ù…Ø¹ØªØ¨Ø±."

  read -rp "IP Ø¹Ù…ÙˆÙ…ÛŒ Ø³Ø±ÙˆØ± Ù…Ù‚Ø§Ø¨Ù„: " PEER_PUBLIC_IP
  [[ -n "$PEER_PUBLIC_IP" ]] || die "IP Ù…Ù‚Ø§Ø¨Ù„ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª."

  read -rp "Ù¾ÙˆØ±Øª SoftEther (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ 8443): " SOFTETHER_PORT
  SOFTETHER_PORT="${SOFTETHER_PORT:-8443}"
  [[ "$SOFTETHER_PORT" =~ ^[0-9]+$ ]] || die "Ù¾ÙˆØ±Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±."

  read -rp "Ù†Ø§Ù… HUB (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ QAZI): " HUB_NAME
  HUB_NAME="${HUB_NAME:-QAZI}"
  read -rp "Ù†Ø§Ù… ÛŒÙˆØ²Ø± (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ irclient): " USER_NAME
  USER_NAME="${USER_NAME:-irclient}"

  echo
  read -rp "Ù¾Ø³ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ† SoftEther (Ø®Ø§Ù„ÛŒ=ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±): " ADMIN_PASS
  [[ -n "$ADMIN_PASS" ]] || ADMIN_PASS="$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 16)"
  echo "ğŸ” ADMIN_PASS: $ADMIN_PASS"
  read -rp "Ù¾Ø³ÙˆØ±Ø¯ HUB (Ø®Ø§Ù„ÛŒ=ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±): " HUB_PASS
  [[ -n "$HUB_PASS" ]] || HUB_PASS="$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 16)"
  echo "ğŸ” HUB_PASS: $HUB_PASS"
  read -rp "Ù¾Ø³ÙˆØ±Ø¯ ÛŒÙˆØ²Ø± (Ø®Ø§Ù„ÛŒ=ØªÙˆÙ„ÛŒØ¯ Ø®ÙˆØ¯Ú©Ø§Ø±): " USER_PASS
  [[ -n "$USER_PASS" ]] || USER_PASS="$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 16)"
  echo "ğŸ” USER_PASS: $USER_PASS"

  echo
  echo "ğŸ“¦ Installing prerequisitesâ€¦"
  apt update
  apt install -y curl nftables nginx
  systemctl enable --now nftables

  if [[ "$ROLE" == "OUT" ]]; then
    apt_has_pkg softether-vpnserver || die "softether-vpnserver Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Universe Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†: add-apt-repository universe -y"
    install_softether_server_apt
  else
    apt_has_pkg softether-vpnclient || die "softether-vpnclient Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Universe Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†: add-apt-repository universe -y"
    install_softether_client_apt
  fi

  sed -i "s/^ROLE=.*/ROLE=$ROLE/" "$STATE_FILE"
  sed -i "s/^PEER_PUBLIC_IP=.*/PEER_PUBLIC_IP=$PEER_PUBLIC_IP/" "$STATE_FILE"
  sed -i "s/^SOFTETHER_PORT=.*/SOFTETHER_PORT=$SOFTETHER_PORT/" "$STATE_FILE"
  sed -i "s/^HUB_NAME=.*/HUB_NAME=$HUB_NAME/" "$STATE_FILE"
  sed -i "s/^USER_NAME=.*/USER_NAME=$USER_NAME/" "$STATE_FILE"
  sed -i "s/^ADMIN_PASS=.*/ADMIN_PASS=$ADMIN_PASS/" "$STATE_FILE"
  sed -i "s/^HUB_PASS=.*/HUB_PASS=$HUB_PASS/" "$STATE_FILE"
  sed -i "s/^USER_PASS=.*/USER_PASS=$USER_PASS/" "$STATE_FILE"

  echo
  echo "âš™ï¸ SoftEther basic configâ€¦"
  if [[ "$ROLE" == "OUT" ]]; then
    vpncmd localhost /SERVER /CMD ServerPasswordSet "$ADMIN_PASS" >/dev/null
    vpncmd localhost /SERVER /CMD HubCreate "$HUB_NAME" /PASSWORD:"$HUB_PASS" >/dev/null 2>&1 || true
    vpncmd localhost /SERVER /HUB:"$HUB_NAME" /CMD UserCreate "$USER_NAME" >/dev/null 2>&1 || true
    vpncmd localhost /SERVER /HUB:"$HUB_NAME" /CMD UserPasswordSet "$USER_NAME" /PASSWORD:"$USER_PASS" >/dev/null
    vpncmd localhost /SERVER /CMD ListenerCreate "$SOFTETHER_PORT" >/dev/null 2>&1 || true
    vpncmd localhost /SERVER /HUB:"$HUB_NAME" /CMD SecureNatEnable >/dev/null 2>&1 || true
    open_tcp_port "$SOFTETHER_PORT"
    echo "âœ… OUT ready. TCP/$SOFTETHER_PORT Ø¨Ø§ÛŒØ¯ Ø±ÙˆÛŒ ÙØ§ÛŒØ±ÙˆØ§Ù„ Ø¨Ø§Ø² Ø¨Ø§Ø´Ø¯."
  else
    vpncmd localhost /CLIENT /CMD NicCreate qaznic >/dev/null 2>&1 || true
    vpncmd localhost /CLIENT /CMD AccountCreate qazacc /SERVER:"$PEER_PUBLIC_IP":"$SOFTETHER_PORT" /HUB:"$HUB_NAME" /USERNAME:"$USER_NAME" /NICNAME:qaznic >/dev/null 2>&1 || true
    vpncmd localhost /CLIENT /CMD AccountPasswordSet qazacc /PASSWORD:"$USER_PASS" >/dev/null
    vpncmd localhost /CLIENT /CMD AccountConnect qazacc >/dev/null 2>&1 || true
    echo "âœ… IR client connect command sent."
  fi

  echo
  read -rp "Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ø§Ù„Ø§Ù† VPN_IF Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒÙ…ØŸ (y/n): " yn
  [[ "$yn" =~ ^[Yy]$ ]] && pick_vpn_if || true

  echo
  read -rp "IP Ø·Ø±Ù Ù…Ù‚Ø§Ø¨Ù„ Ø¯Ø§Ø®Ù„ VPN Ø¨Ø±Ø§ÛŒ Health-Check (PEER_IP) (Ù…Ø«Ø§Ù„ 10.10.10.2): " peer_vpn_ip
  [[ -n "$peer_vpn_ip" ]] && sed -i "s/^PEER_IP=.*/PEER_IP=$peer_vpn_ip/" "$HEALTH_FILE" || true

  echo
  echo "Ù¾Ù†Ù„ x-ui Ø±ÙˆÛŒ Ú©Ø¯Ø§Ù… Ø³Ø±ÙˆØ± Ø§Ø³ØªØŸ"
  echo "  1) Ù‡Ù…ÛŒÙ† Ø³Ø±ÙˆØ±"
  echo "  2) Ø³Ø±ÙˆØ± Ù…Ù‚Ø§Ø¨Ù„"
  echo "  3) Ù†Ø¯Ø§Ø±Ù…/Ù…Ù‡Ù… Ù†ÛŒØ³Øª"
  read -rp "Ø§Ù†ØªØ®Ø§Ø¨ (1/2/3): " xsel

  if [[ "$xsel" == "2" && -n "$peer_vpn_ip" ]]; then
    read -rp "Ù¾ÙˆØ±Øª Ù¾Ù†Ù„ x-ui Ø±ÙˆÛŒ Ø³Ø±ÙˆØ± Ù…Ù‚Ø§Ø¨Ù„ (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ 54321): " xui_peer_port
    xui_peer_port="${xui_peer_port:-54321}"
    read -rp "Ù¾ÙˆØ±Øª Ø¹Ù…ÙˆÙ…ÛŒ Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù¾Ù†Ù„ (Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ 15432): " pubx
    pubx="${pubx:-15432}"
    if [[ -n "${VPN_IF:-}" ]]; then
      tcp_add_noninteractive "xui_panel" "$pubx" "$peer_vpn_ip" "$xui_peer_port"
      echo "âœ… Forward Ù¾Ù†Ù„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯: :$pubx â†’ $peer_vpn_ip:$xui_peer_port"
    else
      echo "âš ï¸ VPN_IF Ø³Øª Ù†Ø´Ø¯Ù‡Ø› Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†."
    fi
  elif [[ "$xsel" == "1" ]]; then
    local p; p="$(detect_xui_port_local)"
    [[ -n "$p" ]] && echo "âœ… x-ui ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯ (Ù¾ÙˆØ±Øª Ø§Ø­ØªÙ…Ø§Ù„ÛŒ: $p)" || echo "âš ï¸ x-ui ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯."
  fi

  echo
  echo "Ø§ÙØ²ÙˆØ¯Ù† Ù‚ÙˆØ§Ù†ÛŒÙ† TCP (public:dst_ip:dst_port). Ø®Ø§Ù„ÛŒ=Ø§ØªÙ…Ø§Ù…"
  while true; do
    read -rp "TCP rule: " line
    [[ -z "$line" ]] && break
    IFS=':' read -r pp dip dp <<<"$line"
    [[ "$pp" =~ ^[0-9]+$ && -n "${dip:-}" && "$dp" =~ ^[0-9]+$ ]] || { echo "ÙØ±Ù…Øª ØºÙ„Ø·"; continue; }
    tcp_add_noninteractive "tcp_${pp}_${dp}" "$pp" "$dip" "$dp"
    echo "âœ… :$pp â†’ $dip:$dp"
  done

  if have nginx; then
    ensure_nginx_include
    echo
    echo "Ø§ÙØ²ÙˆØ¯Ù† Ù‚ÙˆØ§Ù†ÛŒÙ† HTTP (domain:dst_ip:dst_port). Ø®Ø§Ù„ÛŒ=Ø§ØªÙ…Ø§Ù…"
    while true; do
      read -rp "HTTP rule: " line
      [[ -z "$line" ]] && break
      IFS=':' read -r dom dip dp <<<"$line"
      [[ -n "${dom:-}" && -n "${dip:-}" && "$dp" =~ ^[0-9]+$ ]] || { echo "ÙØ±Ù…Øª ØºÙ„Ø·"; continue; }
      http_add_noninteractive "http_${dp}" "$dom" "$dip" "$dp"
      echo "âœ… http://$dom â†’ $dip:$dp"
    done
  fi

  if [[ -n "${VPN_IF:-}" ]]; then
    apply_all
    have nginx && nginx -t && systemctl reload nginx || true
  else
    echo "âš ï¸ VPN_IF Ø³Øª Ù†Ø´Ø¯Ù‡Ø› Ø¨Ø¹Ø¯Ø§Ù‹ Apply Ø±Ø§ Ø¨Ø²Ù†."
  fi

  echo
  read -rp "systemd units (apply+health timer) Ù†ØµØ¨ Ø´ÙˆØ¯ØŸ (y/n): " su
  [[ "$su" =~ ^[Yy]$ ]] && install_units || true

  echo "ğŸ‰ Done."
  pause
}

menu(){
  while true; do
    print_header
    echo "1) FAST Bootstrap (APT SoftEther)"
    echo "2) Apply (nft + nginx)"
    echo "3) Health-check (one shot)"
    echo "4) Install systemd units"
    echo "0) Exit"
    read -rp "Ø§Ù†ØªØ®Ø§Ø¨: " c
    case "$c" in
      1) bootstrap ;;
      2) need_root; apply_all; pause ;;
      3) health_check; pause ;;
      4) install_units; pause ;;
      0) exit 0 ;;
      *) echo "Ú¯Ø²ÛŒÙ†Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±"; pause ;;
    esac
  done
}

case "${1:-}" in
  --bootstrap) bootstrap; exit 0 ;;
  --apply) need_root; apply_all; exit 0 ;;
  --health-check) health_check ;;
  --install-units) install_units; exit 0 ;;
esac

need_root
ensure_dirs
menu
